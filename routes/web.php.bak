<?php

use Illuminate\Support\Facades\Route;
use Illuminate\Support\Facades\Auth;
use App\Http\Controllers\UserController;
use App\Http\Controllers\CentreController;
use App\Http\Controllers\ProfesseurController;
use App\Http\Controllers\ProfileController;
use App\Http\Controllers\ApplicationController;
use App\Http\Controllers\DashboardController;
use App\Http\Controllers\PaiementController;
use App\Http\Controllers\Auth\LoginController;
use App\Http\Controllers\Profile\AvatarController;
use App\Http\Controllers\EnseignementController;
use App\Http\Controllers\AbsenceController;
use App\Http\Controllers\SalaireController;
use App\Http\Controllers\NotificationController;
use App\Http\Controllers\RapportController;
use App\Http\Controllers\ComponentExampleController;
use App\Http\Controllers\TestController;
use App\Http\Controllers\Admin\DashboardController as AdminDashboardController;
use App\Http\Controllers\ProfesseurDashboardController;
use App\Http\Controllers\AssistantDashboardController;
use App\Http\Controllers\EleveDashboardController;

/*
|--------------------------------------------------------------------------
| Routes Web - Allo Tawjih
|--------------------------------------------------------------------------
| Routes pour la plateforme de gestion des centres de cours
|--------------------------------------------------------------------------
*/

// Page d'accueil
Route::get('/', function () {
    if (Auth::check()) {
        return app(LoginController::class)->redirectBasedOnRole(Auth::user());
    }
    return view('welcome');
})->name('welcome');

// Exemples de composants
Route::get('/composants', [ComponentExampleController::class, 'index'])->name('components.examples');

// Routes d'authentification de base
Route::get('/login', [LoginController::class, 'showLoginForm'])->name('login');
Route::post('/login', [LoginController::class, 'login']);
Route::post('/logout', [LoginController::class, 'logout'])->name('logout');

// Routes accessibles aux invités
Route::middleware('guest')->group(function () {
    Route::get('/forgot-password', [LoginController::class, 'showForgotPasswordForm'])->name('password.request');
    Route::post('/forgot-password', [LoginController::class, 'sendResetLink'])->name('password.email');
    Route::get('/reset-password/{token}', [LoginController::class, 'showResetForm'])->name('password.reset');
    Route::post('/reset-password', [LoginController::class, 'reset'])->name('password.update');
});

// Routes protégées par authentification et rôle
Route::middleware(['auth', 'active'])->group(function () {
    // Redirection pour les utilisateurs authentifiés
    Route::get('/home', function () {
        return redirect()->route('dashboard');
    })->name('home');

    // Routes du profil utilisateur
    Route::prefix('profile')->name('profile.')->group(function () {
        Route::get('/', [ProfileController::class, 'edit'])->name('edit');
        Route::patch('/', [ProfileController::class, 'update'])->name('update');
        Route::patch('/avatar', [AvatarController::class, 'update'])->name('avatar');
        Route::delete('/', [ProfileController::class, 'destroy'])->name('destroy');
    });

    // ============================================================================
    // ROUTES ADMIN (Rôle: admin)
    // ============================================================================
    Route::middleware(['role:admin'])->prefix('admin')->name('admin.')->group(function () {
        // Tableau de bord
        Route::get('/dashboard', [AdminDashboardController::class, 'index'])->name('dashboard');
        
        // Gestion des utilisateurs
        Route::resource('users', UserController::class);
        
        // Gestion des paiements
        Route::resource('paiements', PaiementController::class);
        
        // Autres ressources
        Route::resource('centres', CentreController::class);
        Route::resource('professeurs', ProfesseurController::class);
        Route::resource('enseignements', EnseignementController::class);
        Route::resource('absences', AbsenceController::class);
        
        // Gestion des salaires
        Route::prefix('salaires')->name('salaires.')->group(function () {
            Route::resource('salaires', SalaireController::class);
        });
        
        // Rapports
        Route::prefix('rapports')->name('rapports.')->group(function () {
            Route::get('/', [RapportController::class, 'index'])->name('index');
            Route::get('/export', [RapportController::class, 'export'])->name('export');
        });
    });

    // ============================================================================
    // ROUTES PROFESSEUR (Rôle: professeur)
    // ============================================================================
    Route::middleware(['role:professeur'])->prefix('professeur')->name('professeur.')->group(function () {
        Route::get('/dashboard', [ProfesseurDashboardController::class, 'index'])->name('dashboard');
        // Autres routes professeur à ajouter plus tard
    });

    // ============================================================================
    // ROUTES ASSISTANT (Rôle: assistant)
    // ============================================================================
    Route::middleware(['role:assistant'])->prefix('assistant')->name('assistant.')->group(function () {
        Route::get('/dashboard', [AssistantDashboardController::class, 'index'])->name('dashboard');
        // Autres routes assistant à ajouter plus tard
    });

    // ============================================================================
    // ROUTES ELEVE (Rôle: eleve)
    // ============================================================================
    Route::middleware(['role:eleve'])->prefix('eleve')->name('eleve.')->group(function () {
        Route::get('/dashboard', [EleveDashboardController::class, 'index'])->name('dashboard');
        // Autres routes élève à ajouter plus tard
    });
});

// Routes de test (à supprimer en production)
Route::prefix('test')->group(function () {
    Route::get('/salaires/calculer/{mois?}', [\App\Http\Controllers\TestSalaireController::class, 'testCalculerSalaires'])->name('test.salaires.calculer');
});
        Route::resource('ressources', \App\Http\Controllers\Professeur\RessourceController::class);
        
        // Profil
        Route::get('/profil', [\App\Http\Controllers\Professeur\ProfilController::class, 'edit'])->name('profil.edit');
        Route::put('/profil', [\App\Http\Controllers\Professeur\ProfilController::class, 'update'])->name('profil.update');
        
        // Gestion des salaires
        Route::get('/salaires', [\App\Http\Controllers\Professeur\SalaireController::class, 'index'])->name('salaires.index');
        Route::get('/salaires/{salaire}', [\App\Http\Controllers\Professeur\SalaireController::class, 'show'])->name('salaires.show');
    }); // Fin du groupe professeur
    
    // ============================================================================
    // ROUTES ASSISTANT
    // ============================================================================
    
    require __DIR__.'/assistant.php';
}); // Fin du groupe auth active

// Routes de test (à supprimer en production)
Route::prefix('test')->group(function () {
    Route::get('/salaires/calculer/{mois?}', [\App\Http\Controllers\TestSalaireController::class, 'testCalculerSalaires'])->name('test.salaires.calculer');
    Route::post('/salaires/{salaire}/valider', [\App\Http\Controllers\TestSalaireController::class, 'testValiderPaiement'])->name('test.salaires.valider');
    Route::post('/salaires/{salaire}/annuler', [\App\Http\Controllers\TestSalaireController::class, 'testAnnulerSalaire'])->name('test.salaires.annuler');
});

// ============================================================================
// ROUTE CATCH-ALL POUR INERTIA.JS (doit être en dernier et seulement pour les routes non définies)
// ============================================================================

Route::fallback(function () {
    if (request()->is('api/*') || request()->is('_debugbar/*')) {
        abort(404);
    }
    
    // Si la route n'existe pas, on renvoie la vue d'erreur 404
    return Inertia::render('Errors/404', [
        'status' => 404,
    ])->toResponse(request())->setStatusCode(404);
});