<?php

namespace App\Http\Controllers\Eleve;

use App\Enums\RoleType;
use App\Http\Controllers\Controller;
use App\Models\Absence;
use App\Models\Matiere;
use App\Models\User;
use App\Services\NotificationService;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;

class AbsenceController extends Controller
{
    protected $notificationService;

    public function __construct(NotificationService $notificationService)
    {
        $this->notificationService = $notificationService;
    }

    // ... (le reste du code existant)

    /**
     * Télécharge une pièce jointe de justification
     *
     * @param  \App\Models\Absence  $absence
     * @return \Symfony\Component\HttpFoundation\StreamedResponse
     */
    public function downloadJustification(Absence $absence)
    {
        // Vérifier que l'utilisateur a le droit de voir cette pièce jointe
        if ($absence->etudiant_id !== Auth::id() && !Auth::user()->hasRole(['admin', 'professeur', 'assistant'])) {
            abort(403, 'Accès non autorisé');
        }
        
        if (!$absence->piece_jointe) {
            abort(404, 'Aucun fichier joint trouvé');
        }
        
        $path = storage_path('app/public/' . $absence->piece_jointe);
        
        if (!file_exists($path)) {
            abort(404, 'Le fichier est introuvable');
        }
        
        $fileName = 'justification_' . Str::slug($absence->matiere->nom ?? 'absence') . '_' . $absence->date_absence->format('Y-m-d') . '.' . pathinfo($path, PATHINFO_EXTENSION);
        
        return response()->download($path, $fileName);
    }
}
